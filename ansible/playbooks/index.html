



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://agarthetiger.github.io/mkdocs/ansible/playbooks/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Playbooks - Software Engineering Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../#playbooks" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://agarthetiger.github.io/mkdocs/" title="Software Engineering Notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Software Engineering Notes
              </span>
              <span class="md-header-nav__topic">
                Playbooks
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://agarthetiger.github.io/mkdocs/" title="Software Engineering Notes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Software Engineering Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Ansible
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Ansible
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Ansible/" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Playbooks
      </label>
    
    <a href="./" title="Playbooks" class="md-nav__link md-nav__link--active">
      Playbooks
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#conditional-checks" title="Conditional checks" class="md-nav__link">
    Conditional checks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-check-examples" title="Conditional check examples" class="md-nav__link">
    Conditional check examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filters" title="Filters" class="md-nav__link">
    Filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#play-options" title="Play options" class="md-nav__link">
    Play options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-and-include" title="Import and Include" class="md-nav__link">
    Import and Include
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Jenkins
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Jenkins
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins/JenkinsPlugins/" title="Jenkins Plugins" class="md-nav__link">
      Jenkins Plugins
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins/PipelineSteps/" title="Pipeline Steps" class="md-nav__link">
      Pipeline Steps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/mkdocs/" title="MKDocs" class="md-nav__link">
      MKDocs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#conditional-checks" title="Conditional checks" class="md-nav__link">
    Conditional checks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-check-examples" title="Conditional check examples" class="md-nav__link">
    Conditional check examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filters" title="Filters" class="md-nav__link">
    Filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#play-options" title="Play options" class="md-nav__link">
    Play options
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-and-include" title="Import and Include" class="md-nav__link">
    Import and Include
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="playbooks">Playbooks<a class="headerlink" href="#playbooks" title="Permanent link">&para;</a></h1>
<h2 id="conditional-checks">Conditional checks<a class="headerlink" href="#conditional-checks" title="Permanent link">&para;</a></h2>
<p>Conditional checks use the <code>when:</code> syntax. The <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html">Ansible documentation</a> states "...When conditions are raw Jinja2 expressions and don't require double quotes for variable interpolation.", which is not entirely accurate. When conditions can use raw Jinja2 expressions but can execute regular python code so can access methods like String.find() to check for a text match in a String. Multiple conditions should be enclosed with parenthesis, multiple conditions can be specified in a list where they are all required to be true (logical AND).</p>
<h3 id="conditional-check-examples">Conditional check examples<a class="headerlink" href="#conditional-check-examples" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>    <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> 
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tomcat_status_result.stdout.find(&quot;JVM is running.&quot;) &gt; -1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tomcat_status_result.stderr != &quot;&quot;</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tomcat_status_result.rc == 0</span>

    <span class="l l-Scalar l-Scalar-Plain">---</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
      <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;print</span><span class="nv"> </span><span class="s">inventory</span><span class="nv"> </span><span class="s">vars&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">var</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">inventory_dir</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">inventory_file</span>
          <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">inventory_dir | regex_search(&#39;dev$&#39;)</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
      <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;apply</span><span class="nv"> </span><span class="s">stub</span><span class="nv"> </span><span class="s">role&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">include_role</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">issuer-wallet-stub</span>
          <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">inventory_dir | regex_search(&#39;dev$&#39;)</span>
</pre></div>


<h2 id="filters">Filters<a class="headerlink" href="#filters" title="Permanent link">&para;</a></h2>
<p>See documentation on <a href="http://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">filters</a>.
Filters use Jinja2, and Ansible ships with some extra ones to those available in Jinja2. Remember that if using a filter in a conditional statement that python methods are also accessible. </p>
<p>Also note that the online <a href="http://jinja.pocoo.org/docs/2.10/templates/#builtin-filters">Jinja2 documentation</a> doesn't go back to python-jinja2 2.7 which is what is provided in RedHat repos for RHEL7. There are no RHEL plans to update Jinja2 to anything later, so what you read on the Jinja website will include features not available to Ansible on RHEL7, because of the Jinja2 version. </p>
<p>To select an item from a list, based on an attribute, use the selectattr with the match filter, as the equalsto filter is only available in Jinja2 2.8.</p>
<p>Given a yaml file like this,</p>
<div class="codehilite"><pre><span></span>    <span class="l l-Scalar l-Scalar-Plain">projects</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-a</span>
        <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;2.3.4-SNAPSHOT&#39;</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-b</span>
        <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;1.2.3-SNAPSHOT&#39;</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-c</span>
        <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&#39;5.6.7-SNAPSHOT&#39;</span>
</pre></div>


<p>Select the version of project-b using the following expression.</p>
<div class="codehilite"><pre><span></span>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-hosts-b</span>
      <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">deployable_version</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">projects</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">selectattr(&#39;name&#39;,</span><span class="nv"> </span><span class="s">&#39;match&#39;,</span><span class="nv"> </span><span class="s">&#39;^project-b$&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map(attribute=&#39;version&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">first</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>


<p>References</p>
<ul>
<li><a href="http://www.oznetnerd.com/jinja2-selectattr-filter/">jinja2-selectattr-filter</a></li>
</ul>
<h2 id="debug">Debug<a class="headerlink" href="#debug" title="Permanent link">&para;</a></h2>
<p>Use this to debug what is available in hostvars quickly. gather_facts: false would not be a useful option on first execution of this.</p>
<div class="codehilite"><pre><span></span>- hosts: ondemand
  gather_facts: false
  tasks:
  - name: &quot;test hostvars for target_environment&quot;
    debug:
      var: hostvars
</pre></div>


<p>You can print a message with variable information in it.</p>
<div class="codehilite"><pre><span></span><span class="x">- debug:</span>
<span class="x">    msg: &quot;System </span><span class="cp">{{</span> <span class="nv">inventory_hostname</span> <span class="cp">}}</span><span class="x"> has gateway </span><span class="cp">{{</span> <span class="nv">ansible_default_ipv4.gateway</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  when: ansible_default_ipv4.gateway is defined</span>
</pre></div>


<p>You can dump the contents of a list or map, and set a verbosity level, below which the debug will not output anything. </p>
<div class="codehilite"><pre><span></span>- name: Display all variables/facts known for a host
  debug:
    var: hostvars[inventory_hostname]
    verbosity: 4
</pre></div>


<p>See documentation for the <a href="http://docs.ansible.com/ansible/latest/modules/debug_module.html">debug module</a>.</p>
<h2 id="play-options">Play options<a class="headerlink" href="#play-options" title="Permanent link">&para;</a></h2>
<p>Disable facts gathering</p>
<div class="codehilite"><pre><span></span>- hosts: all
  gather_facts: false
</pre></div>


<h2 id="import-and-include">Import and Include<a class="headerlink" href="#import-and-include" title="Permanent link">&para;</a></h2>
<p>Ansible documentation on <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.html">Creating reusable playbooks</a>
Note there are trade-offs when selecting between static and dynamic, any import* tasks will be static, any include* tasks will be dynamic. </p>
<ul>
<li>All <code>import*</code> statements are pre-processed at the time playbooks are parsed.</li>
<li>All <code>include*</code> statements are processed as they encountered during the execution of the playbook.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Ansible/" title="Ansible" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Ansible
              </span>
            </div>
          </a>
        
        
          <a href="../../jenkins/JenkinsPlugins/" title="Jenkins Plugins" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Jenkins Plugins
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/agarthetiger" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://uk.linkedin.com/in/buildthethingright" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>
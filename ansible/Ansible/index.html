



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.6">
    
    
      
        <title>Ansible Notes - Software Engineering Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#ansible-notes" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Software Engineering Notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Software Engineering Notes
              </span>
              <span class="md-header-nav__topic">
                Ansible Notes
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Software Engineering Notes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Software Engineering Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Ansible
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Ansible
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Ansible Notes
      </label>
    
    <a href="./" title="Ansible Notes" class="md-nav__link md-nav__link--active">
      Ansible Notes
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#single-action" title="Single action" class="md-nav__link">
    Single action
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-actions" title="Local actions" class="md-nav__link">
    Local actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#localhost-and-non-ssh-connections" title="Localhost and non-SSH connections" class="md-nav__link">
    Localhost and non-SSH connections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-checks" title="Conditional checks" class="md-nav__link">
    Conditional checks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filters" title="Filters" class="md-nav__link">
    Filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-variables-from-a-file" title="Load variables from a file" class="md-nav__link">
    Load variables from a file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-and-include" title="Import and Include" class="md-nav__link">
    Import and Include
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roles" title="Roles" class="md-nav__link">
    Roles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magic-variables" title="Magic variables" class="md-nav__link">
    Magic variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-useful-stuff" title="General useful stuff" class="md-nav__link">
    General useful stuff
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group-and-host-variables" title="Group and Host Variables" class="md-nav__link">
    Group and Host Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ansible-tower" title="Ansible Tower" class="md-nav__link">
    Ansible Tower
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ansible-tools" title="Ansible tools" class="md-nav__link">
    Ansible tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansible-run-analysis-ara" title="Ansible Run Analysis (ARA)" class="md-nav__link">
    Ansible Run Analysis (ARA)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Jenkins
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Jenkins
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins/JenkinsPlugins/" title="Jenkins Plugins" class="md-nav__link">
      Jenkins Plugins
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins/PipelineSteps/" title="Pipeline Steps" class="md-nav__link">
      Pipeline Steps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/mkdocs/" title="MKDocs" class="md-nav__link">
      MKDocs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#single-action" title="Single action" class="md-nav__link">
    Single action
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-actions" title="Local actions" class="md-nav__link">
    Local actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#localhost-and-non-ssh-connections" title="Localhost and non-SSH connections" class="md-nav__link">
    Localhost and non-SSH connections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-checks" title="Conditional checks" class="md-nav__link">
    Conditional checks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filters" title="Filters" class="md-nav__link">
    Filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-variables-from-a-file" title="Load variables from a file" class="md-nav__link">
    Load variables from a file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-and-include" title="Import and Include" class="md-nav__link">
    Import and Include
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roles" title="Roles" class="md-nav__link">
    Roles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magic-variables" title="Magic variables" class="md-nav__link">
    Magic variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-useful-stuff" title="General useful stuff" class="md-nav__link">
    General useful stuff
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group-and-host-variables" title="Group and Host Variables" class="md-nav__link">
    Group and Host Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ansible-tower" title="Ansible Tower" class="md-nav__link">
    Ansible Tower
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ansible-tools" title="Ansible tools" class="md-nav__link">
    Ansible tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansible-run-analysis-ara" title="Ansible Run Analysis (ARA)" class="md-nav__link">
    Ansible Run Analysis (ARA)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="ansible-notes">Ansible Notes</h1>
<h2 id="single-action">Single action</h2>
<pre><code>ansible all -m setup -i 127.0.0.1, --connection=local
</code></pre>
<ul>
<li><code>ansible all</code> execute ansible against host group 'all'    </li>
<li><code>-m setup</code> run the setup module to gather information about the hosts</li>
<li><code>-i 127.0.0.1,</code> inline host list, must be comma-separated list of hosts so add training comman for a single host</li>
<li><code>--connection=local</code> instruct ansible to just run locally and not to try and establish an SSH connection. Useful if local loobpack is disabled eg. due to firewall rules or security groups. </li>
</ul>
<p>See <a href="https://docs.ansible.com/ansible/latest/modules/setup_module.html#examples">Examples</a> on the Ansible Setup module documentation.</p>
<h2 id="local-actions">Local actions</h2>
<p>If you want to run a playbook and always do things locally, use <code>- hosts: 127.0.0.1</code> in the playbook. Execute the playbook using <code>--connection=local</code></p>
<p>To run a playbook which uses <code>- hosts: all</code> or similar, pass an inventory with just localhost or 127.0.0.1 and connection=local</p>
<pre><code>ansible-playbook -i 127.0.0.1, --connection=local myplaybook.yaml
</code></pre>
<p>Alternatively, within a playbook with tasks to be executed remotely, include a section with </p>
<pre><code>- hosts: 127.0.0.1
  connection: local
</code></pre>
<p>More alternatives include using the <code>local_action</code> module which is a shorthand syntax for  the <code>delegate_to: 127.0.0.1</code> option. Combine these with <code>run_once: true</code> to ensure things running locally only happen once if that's what you want (like downloading a file once to then use Ansible to push the file to multiple hosts). </p>
<p>See Ansible documentation on <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_delegation.html#delegation">Delegation</a> This is useful to switch to running selected tasks locally in the middle of a role execution for example, where you cannot add hosts: directives to switch between local and remote execution.</p>
<pre><code>- hosts: all
  gather_facts: false
  tasks:
  - name: ensure required parameters have been set
    fail: msg="Variable '{{ item }}' is not defined"
    when: item not in vars
    with_items:
      - public_key_file
      - host_user_id
    run_once: true
  - name: locate public key file
    local_action:
      module: stat
      path: "{{ public_key_file }}"
    register: keyFile
    run_once: true
</code></pre>
<h2 id="localhost-and-non-ssh-connections">Localhost and non-SSH connections</h2>
<p><code>ansible_connection=local</code> can be used in the inventory or on the command line to specify how Ansible will connect to the target host. In the case of local actions you can use ansible_connection=local as an inventory parameter with localhost to execute something locally even if you don't have a local loopback connection. The equivalent in a playbook is <code>connection: local</code>.</p>
<p>Note localhost will be recognised by Ansible as a valid host if the /etc/hosts file has an entry for 127.0.0.1 localhost or if <code>localhost 127.0.0.1 ansible_connection=local</code> is specified in the inventory, otherwise use 127.0.0.1.</p>
<h2 id="conditional-checks">Conditional checks</h2>
<p>Conditional checks use the when: syntax. When conditions are raw Jinja2 expressions and don't require double quotes for variable interpolation.</p>
<pre><code>---
- hosts: all
  tasks:
    - name: "print inventory vars"
      debug:
        var: "{{ item }}"
      with_items:
        - inventory_dir
        - inventory_file
      when: inventory_dir | regex_search('dev$')

- hosts: all
  tasks:
    - name: "apply stub role"
      include_role:
        name: issuer-wallet-stub
      when: inventory_dir | regex_search('dev$')

...
</code></pre>
<h2 id="filters">Filters</h2>
<p>See documentation on <a href="http://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">filters</a>.
Filters are really provided by Jinja2, which is python under the hood. Note that the online <a href="http://jinja.pocoo.org/docs/2.10/templates/#builtin-filters">Jinja2 documentation</a> doesn't go back to python-jinja2 2.7 which is what is provided in RedHat repos for RHEL7. There are no RHEL plans to update Jinja2 to anything later, so what you read on the Jinja website will include features not available to Ansible on RHEL7, because of the Jinja2 version. </p>
<p>To select an item from a list, based on an attribute, use the selectattr with the match filter, as the equalsto filter is only available in Jinja2 2.8.</p>
<p>eg. </p>
<p>Yaml file</p>
<pre><code>projects:
  - name: data-services
    version: '2.3.4-SNAPSHOT'
  - name: service-manager
    version: '1.2.3-SNAPSHOT'
  - name: issuer-wallet-service
    value: '5.6.7-SNAPSHOT'
</code></pre>
<p>Select the version of service-manager using the following expression.</p>
<pre><code>- hosts: service-manager
  vars:
    - deployable_version: "{{ projects | selectattr('name', 'match', '^service-manager$') | map(attribute='version') | list | first }}"
</code></pre>
<p>References</p>
<ul>
<li><a href="http://www.oznetnerd.com/jinja2-selectattr-filter/">jinja2-selectattr-filter</a></li>
</ul>
<h2 id="load-variables-from-a-file">Load variables from a file</h2>
<p>On the command line, use -e or --extra-vars. Set additional variables as key=value or YAML/JSON, if filename prepend the filename with @.</p>
<pre><code>ansible-playbook ... --extra-vars '@my-vars.yaml'
</code></pre>
<p>Combine vars from a file and additional vars by using --extra-vars twice.</p>
<pre><code>ansible-playbook ... --extra-vars '@my-vars.yaml' --extra-vars 'target_env=uat generate_report=true'
</code></pre>
<p>See <a href="https://docs.ansible.com/ansible/2.4/ansible-playbook.html#cmdoption-ansible-playbook-e">documentation</a></p>
<h2 id="import-and-include">Import and Include</h2>
<p>https://docs.ansible.com/ansible/2.4/playbooks_reuse_includes.html</p>
<ul>
<li>All <code>import*</code> statements are pre-processed at the time playbooks are parsed.</li>
<li>All <code>include*</code> statements are processed as they encountered during the execution of the playbook.</li>
</ul>
<h2 id="roles">Roles</h2>
<p>Link to Roles documentation
http://docs.ansible.com/ansible/2.4/playbooks_reuse.html</p>
<h2 id="magic-variables">Magic variables</h2>
<p>http://docs.ansible.com/ansible/latest/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts</p>
<h2 id="general-useful-stuff">General useful stuff</h2>
<p>Disable facts gathering</p>
<pre><code>- hosts: all
  gather_facts: false
</code></pre>
<h2 id="group-and-host-variables">Group and Host Variables</h2>
<p>See documentation for <a href="http://docs.ansible.com/ansible/latest/playbooks_best_practices.html#group-and-host-variables">playbooks best practices</a>.</p>
<p>inventory/group_vars/all.yaml
my_var_name: "some value"</p>
<p>Use {{ hostvars[inventory_hostname]['my_var_name'] }} to reference. Note the group_vars/all structure does not mean there is an [all] hosts group to reference, but the vars in all will get applied to all group (hosts), and can be referenced using the magic variable inventory_hostname. Note the use of single quotes for the my_var_name (which is looking up the string 'my_var_name') vs the [inventory_hostname] syntax to index the inventory_hostname in the hostvars array. </p>
<h2 id="debug">Debug</h2>
<p>Use this to debug what is available in hostvars quickly. gather_facts: false would not be a useful option on first execution of this.</p>
<pre><code>- hosts: ondemand
  gather_facts: false
  tasks:
  - name: "test hostvars for target_environment"
    debug:
      var: hostvars
</code></pre>
<p>You can print a message with variable information in it.</p>
<pre><code>- debug:
    msg: "System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}"
  when: ansible_default_ipv4.gateway is defined
</code></pre>
<p>You can dump the contents of a list or map, and set a verbosity level, below which the debug will not output anything. </p>
<pre><code>- name: Display all variables/facts known for a host
  debug:
    var: hostvars[inventory_hostname]
    verbosity: 4
</code></pre>
<p>See documentation for the <a href="http://docs.ansible.com/ansible/latest/modules/debug_module.html">debug module</a>.</p>
<h2 id="ansible-tower">Ansible Tower</h2>
<p>AWX is the upstream open-source version of Ansible Tower. See the <a href="https://www.ansible.com/products/awx-project">AWX Project</a> for details. You can get it from <a href="https://github.com/ansible/awx">GitHub</a>.</p>
<h2 id="ansible-tools">Ansible tools</h2>
<h3 id="ansible-run-analysis-ara">Ansible Run Analysis (ARA)</h3>
<p>See the <a href="https://dzone.com/articles/ansible-run-analysis">ARA</a> article or view the code on <a href="https://github.com/openstack/ara">GitHub</a>.</p>
<p><a href="https://groups.google.com/forum/#!forum/ansible-project">Ansible Google Group</a>
<a href="https://github.com/ansible/ansible/releases">Ansible Source and Releases on GitHub</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../.." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
          <a href="../../jenkins/JenkinsPlugins/" title="Jenkins Plugins" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Jenkins Plugins
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.5e60981f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>